<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laboratorio de Modos</title>
  <!-- Enlaces a Tailwind CSS, Tone.js y html2canvas -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .font-mono {
      font-family: 'Roboto Mono', monospace;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    .animate-slide-up {
      animation: slideUp 0.6s ease-out 0.2s forwards;
      opacity: 0;
    }
    .animate-pulse {
        animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% {
            border-color: #fcd34d;
            box-shadow: 0 0 5px #fcd34d;
        }
        50% {
            border-color: rgba(252, 211, 77, 0.4);
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.8);
        }
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center p-4 pb-12">
  <div id="app-container" class="bg-gray-800 shadow-2xl rounded-3xl p-8 max-w-4xl w-full flex flex-col space-y-8 animate-fade-in">
    <h1 class="text-4xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500 mb-2">
      Laboratorio de Modos
    </h1>
    <p class="text-center text-gray-400 max-w-xl mx-auto">
      Selecciona una nota raíz y un tipo de modo para ver su escala y generar licks.
    </p>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- Selector de Nota Raíz -->
      <div class="flex flex-col items-center">
        <label for="root-note" class="text-xl font-bold mb-2 text-teal-300 flex items-center">
          <i data-lucide="music-2" class="mr-2"></i> Nota Raíz
        </label>
        <div class="relative w-full">
          <select id="root-note" class="w-full bg-gray-700 text-white border-none rounded-xl p-3 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all cursor-pointer">
            <!-- Opciones generadas por JavaScript -->
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
            <i data-lucide="chevron-down" size="20"></i>
          </div>
        </div>
      </div>

      <!-- Selector de Modo/Acorde -->
      <div class="flex flex-col items-center">
        <label for="mode-type" class="text-xl font-bold mb-2 text-teal-300 flex items-center">
          <i data-lucide="scale" class="mr-2"></i> Tipo de Modo
        </label>
        <div class="relative w-full">
          <select id="mode-type" class="w-full bg-gray-700 text-white border-none rounded-xl p-3 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all cursor-pointer">
            <!-- Opciones generadas por JavaScript -->
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
            <i data-lucide="chevron-down" size="20"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección de Resultados -->
    <div id="results-section" class="bg-gray-700 p-6 rounded-2xl mt-8 shadow-inner animate-slide-up">
      <!-- Contenido generado por JavaScript -->
    </div>

    <!-- Sección de Lick Aleatorio -->
    <div id="random-lick-section" class="bg-gray-700 p-6 rounded-2xl mt-8 shadow-inner animate-slide-up">
      <div class="flex justify-center items-center mb-4 space-x-2">
        <h3 class="text-3xl font-extrabold text-white">
          Lick Aleatorio
        </h3>
      </div>

      <!-- Control deslizante para la longitud del lick -->
      <div class="mb-6 w-full flex flex-col items-center">
        <label for="lick-length-slider" class="text-lg font-semibold mb-2 text-gray-300 flex items-center">
          <i data-lucide="grip-lines" class="mr-2"></i> Notas en el lick: <span id="lick-length-value" class="font-mono text-yellow-300 ml-2">4</span>
        </label>
        <!-- Rango del slider ajustado de 1 a 7 -->
        <input type="range" id="lick-length-slider" min="1" max="7" value="4" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="flex flex-wrap justify-center gap-4 mb-4">
        <button id="generate-lick-btn" class="flex items-center px-4 py-2 rounded-full transition-all duration-300 bg-purple-600 hover:bg-purple-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-400">
          <i data-lucide="dice-3" class="mr-2"></i> Generar Nuevo Lick
        </button>
        <button id="save-lick-btn" class="flex items-center px-4 py-2 rounded-full transition-all duration-300 bg-teal-600 hover:bg-teal-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed">
          <i data-lucide="save" class="mr-2"></i> Guardar Lick
        </button>
        <button id="export-lick-btn" class="flex items-center px-4 py-2 rounded-full transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed">
          <i data-lucide="download" class="mr-2"></i> Exportar
        </button>
      </div>
      
      <div id="random-lick-display" class="flex flex-col items-center">
        <!-- Lick aleatorio generado por JavaScript -->
      </div>
    </div>

    <!-- Sección de Licks Guardados -->
    <div id="saved-licks-section" class="bg-gray-700 p-6 rounded-2xl mt-8 shadow-inner animate-slide-up">
      <h3 class="text-3xl font-extrabold text-white text-center mb-4">
        Licks Guardados
      </h3>
      <div id="saved-licks-container" class="flex flex-col space-y-6">
        <!-- Licks guardados generados por JavaScript -->
      </div>
    </div>
    
    <!-- Créditos del desarrollador -->
    <div class="mt-8 text-center text-gray-500 text-sm">
      <p>Creado por Juan Miguel Rios Redondo</p>
    </div>
  </div>
  
  <!-- Contenedor para mensajes de error, inicialmente oculto -->
  <div id="error-message" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div class="bg-red-800 text-white p-6 rounded-xl shadow-2xl flex flex-col items-center space-y-4">
          <i data-lucide="alert-triangle" class="w-16 h-16 text-yellow-400"></i>
          <h2 class="text-2xl font-bold">¡Ha ocurrido un error!</h2>
          <p id="error-details" class="text-center text-red-200">La aplicación no pudo cargar correctamente. Por favor, recarga la página.</p>
      </div>
  </div>
  
  <script>
    // Variables globales
    let synth = null;
    let lickSequence = null;
    let isLickPlaying = false;
    let currentPlayingNoteIndex = null;
    let currentLickPlayingIndex = null;
    let randomLick = [];
    let randomLickIntervals = [];
    let savedLicks = [];

    // Constantes musicales
    const NOTES = ['C', 'C#', 'Db', 'D', 'D#', 'Eb', 'E', 'F', 'F#', 'Gb', 'G', 'G#', 'Ab', 'A', 'A#', 'Bb', 'B'];
    
    const CHROMATIC_SHARPS = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const CHROMATIC_FLATS = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

    const NOTE_TO_SEMITONE_MAP = {
      'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6,
      'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
    };

    // Fórmulas de los acordes principales (corregido para incluir el 5)
    const CHORD_FORMULAS = {
      'maj7 (jónico)': [0, 4, 7, 11],
      'maj7 (Lidio)': [0, 4, 7, 11],
      '7 (Mixolidio)': [0, 4, 7, 10],
      'm7 (Dorico)': [0, 3, 7, 10],
      'm(b6) / maj7/3 (Eolico)': [0, 3, 7, 8],
      '7(sus4) (Frigio)': [0, 5, 7, 10],
      'm7(b5) (Locrio)': [0, 3, 6, 10],
      'V7/II (Mixolidio b6)': [0, 4, 7, 10],
      'V7/III (Mixolidio b2 b6)': [0, 4, 7, 10],
      'V7/IV (Mixolidio)': [0, 4, 7, 10],
      'V7/V (Mixolidio)': [0, 4, 7, 10],
      'V7/VI (Mixolidio b2 b6)': [0, 4, 7, 10]
    };
    
    // Fórmulas de los modos en semitonos (corregido para incluir el 5)
    const MODE_FORMULAS = {
      'maj7 (jónico)': [0, 2, 4, 5, 7, 9, 11],
      'maj7 (Lidio)': [0, 2, 4, 6, 7, 9, 11],
      '7 (Mixolidio)': [0, 2, 4, 5, 7, 9, 10],
      'm7 (Dorico)': [0, 2, 3, 5, 7, 9, 10],
      'm(b6) / maj7/3 (Eolico)': [0, 2, 3, 5, 7, 8, 10],
      '7(sus4) (Frigio)': [0, 1, 3, 5, 7, 8, 10],
      'm7(b5) (Locrio)': [0, 1, 3, 5, 6, 8, 10],
      'V7/II (Mixolidio b6)': [0, 2, 4, 5, 7, 8, 10],
      'V7/III (Mixolidio b2 b6)': [0, 1, 4, 5, 7, 8, 10],
      'V7/IV (Mixolidio)': [0, 2, 4, 5, 7, 9, 10],
      'V7/V (Mixolidio)': [0, 2, 4, 5, 7, 9, 10],
      'V7/VI (Mixolidio b2 b6)': [0, 1, 4, 5, 7, 8, 10]
    };
    
    // Mapa para el nombre de los intervalos según el modo, con la corrección del intervalo '5'
    const INTERVAL_MAPS_BY_MODE = {
      'maj7 (jónico)': { 0: '1', 2: '2', 4: '3', 5: '4', 7: '5', 9: '6', 11: '7' },
      'maj7 (Lidio)': { 0: '1', 2: '2', 4: '3', 6: '#4', 7: '5', 9: '6', 11: '7' },
      '7 (Mixolidio)': { 0: '1', 2: '2', 4: '3', 5: '4', 7: '5', 9: '6', 10: 'b7' },
      'm7 (Dorico)': { 0: '1', 2: '2', 3: 'b3', 5: '4', 7: '5', 9: '6', 10: 'b7' },
      'm(b6) / maj7/3 (Eolico)': { 0: '1', 2: '2', 3: 'b3', 5: '4', 7: '5', 8: 'b6', 10: 'b7' },
      '7(sus4) (Frigio)': { 0: '1', 1: 'b2', 3: 'b3', 5: '4', 7: '5', 8: 'b6', 10: 'b7' },
      'm7(b5) (Locrio)': { 0: '1', 1: 'b2', 3: 'b3', 5: '4', 6: 'b5', 8: 'b6', 10: 'b7' },
      'V7/II (Mixolidio b6)': { 0: '1', 2: '2', 4: '3', 5: '4', 7: '5', 8: 'b6', 10: 'b7' },
      'V7/III (Mixolidio b2 b6)': { 0: '1', 1: 'b2', 4: '3', 5: '4', 7: '5', 8: 'b6', 10: 'b7' },
      'V7/IV (Mixolidio)': { 0: '1', 2: '2', 4: '3', 5: '4', 7: '5', 9: '6', 10: 'b7' },
      'V7/V (Mixolidio)': { 0: '1', 2: '2', 4: '3', 5: '4', 7: '5', 9: '6', 10: 'b7' },
      'V7/VI (Mixolidio b2 b6)': { 0: '1', 1: 'b2', 4: '3', 5: '4', 7: '5', 8: 'b6', 10: 'b7' }
    };
    
    // New mapping for extended degrees
    const degreeMap = {
      '2': '9',
      'b2': 'b9',
      '4': '11',
      '#4': '#11',
      '6': '13',
      'b6': 'b13',
    };

    // Helper function to apply the degree map
    function getDisplayIntervalName(originalInterval) {
        return degreeMap[originalInterval] || originalInterval;
    }

    // Funciones de utilidad para lógica musical
    function isSharpKey(root) {
      return ['C', 'C#', 'D', 'E', 'F#', 'G', 'A', 'B'].includes(root);
    }

    function getCorrectlySpelledNotes(root, intervals, modeType) {
      const isSharp = isSharpKey(root);
      const chromaticScale = isSharp ? CHROMATIC_SHARPS : CHROMATIC_FLATS;
      const rootSemitone = NOTE_TO_SEMITONE_MAP[root];
      const modeIntervals = INTERVAL_MAPS_BY_MODE[modeType];

      const notes = intervals.map(intervalSemitone => {
        const noteIndex = (rootSemitone + intervalSemitone) % 12;
        let noteName = chromaticScale[noteIndex];
        
        if (modeIntervals && modeIntervals[intervalSemitone]) {
          const intervalLabel = modeIntervals[intervalSemitone];
          if (intervalLabel.includes('#')) {
            noteName = CHROMATIC_SHARPS[noteIndex];
          } else if (intervalLabel.includes('b')) {
            noteName = CHROMATIC_FLATS[noteIndex];
          }
        }
        return noteName;
      });
      return notes;
    }
    
    function getIntervalName(modeType, rootNote, targetNote) {
      const rootSemitone = NOTE_TO_SEMITONE_MAP[rootNote];
      const targetSemitone = NOTE_TO_SEMITONE_MAP[targetNote];
      if (rootSemitone === undefined || targetSemitone === undefined) return 'Error';
      const semitoneOffset = (targetSemitone - rootSemitone + 12) % 12;
      const intervalMap = INTERVAL_MAPS_BY_MODE[modeType];
      return intervalMap[semitoneOffset] || 'Error';
    }

    // Funciones de renderizado UI
    function updateScaleAndChordDisplay(selectedRoot, selectedModeType) {
      const modeFormula = MODE_FORMULAS[selectedModeType];
      const chordFormula = CHORD_FORMULAS[selectedModeType];
      
      const chordNotes = getCorrectlySpelledNotes(selectedRoot, chordFormula, selectedModeType);
      const modeNotes = getCorrectlySpelledNotes(selectedRoot, modeFormula, selectedModeType);
      
      const resultsSection = document.getElementById('results-section');
      
      // Lógica para el nombre de la escala según el tipo de modo, con las correcciones solicitadas
      let scaleNameDisplay;
      if (selectedModeType.includes('Eolico')) {
          scaleNameDisplay = 'Escala Eólica';
      } else if (selectedModeType.includes('Frigio')) {
          scaleNameDisplay = 'Escala Frigia';
      } else if (selectedModeType.includes('Locrio')) {
          scaleNameDisplay = 'Escala Locria';
      } else if (selectedModeType.includes('jónico')) {
          scaleNameDisplay = 'Escala Jónica';
      } else if (selectedModeType.includes('Lidio')) {
          scaleNameDisplay = 'Escala Lidia';
      } else if (selectedModeType.includes('Mixolidio b6')) {
          scaleNameDisplay = 'Escala Mixolidia b6';
      } else if (selectedModeType.includes('Mixolidio b2 b6')) {
          scaleNameDisplay = 'Escala Mixolidia b2 b6';
      } else if (selectedModeType.includes('Mixolidio')) {
          scaleNameDisplay = 'Escala Mixolidia';
      } else {
          scaleNameDisplay = `Escala ${selectedModeType.split('(')[1].replace(')', '')}`;
      }
      
      // Lógica para el nombre del acorde, corrigiendo el caso de `sus4`
      let chordName = selectedModeType.split('(')[0].trim();
      if (selectedModeType.includes('sus4')) {
        chordName += '(sus4)';
      }
      
      resultsSection.innerHTML = `
        <div class="flex justify-center items-center mb-4 space-x-2">
          <h2 class="text-3xl font-extrabold text-white">
            ${selectedRoot} ${chordName}
          </h2>
        </div>
        <p class="text-center text-lg text-gray-300 mb-4 font-semibold">
          Acorde: <span class="font-mono text-xl text-yellow-300">${chordNotes.join(', ')}</span>
        </p>
        <hr class="border-gray-600 my-4" />
        <p class="text-center text-lg text-gray-300 mb-2">
          ${scaleNameDisplay}:
        </p>
        <div class="flex justify-center flex-wrap gap-4 mt-4">
          ${modeNotes.map((note, index) => {
            const semitoneOffset = modeFormula[index];
            const originalIntervalName = INTERVAL_MAPS_BY_MODE[selectedModeType][semitoneOffset];
            const displayIntervalName = getDisplayIntervalName(originalIntervalName);
            return `
              <div class="flex flex-col items-center p-2 rounded-lg border-2 border-transparent">
                <span class="font-mono text-2xl font-bold text-green-300">${note}</span>
                <span class="text-sm text-gray-400">${displayIntervalName}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function renderRandomLick() {
      const lickDisplay = document.getElementById('random-lick-display');
      const saveBtn = document.getElementById('save-lick-btn');
      const exportBtn = document.getElementById('export-lick-btn');

      if (randomLick.length === 0) {
        lickDisplay.innerHTML = '';
        if (saveBtn) saveBtn.disabled = true;
        if (exportBtn) exportBtn.disabled = true;
        return;
      }
      
      // Apply the new degree map when rendering
      const displayIntervals = randomLickIntervals.map(getDisplayIntervalName);

      lickDisplay.innerHTML = `
        <div class="flex justify-center flex-wrap gap-4 mt-4" id="random-lick-notes-container">
          ${randomLick.map((note, index) => `
            <div id="random-note-${index}" class="flex flex-col items-center p-2 rounded-lg border-2 transition-all duration-300 border-transparent">
              <span class="font-mono text-2xl font-bold text-yellow-300">${note}</span>
              <span class="text-sm text-gray-400">${displayIntervals[index]}</span>
            </div>
          `).join('')}
        </div>
        <div class="flex justify-center mt-4">
          <button id="play-lick-btn" class="flex items-center px-4 py-2 rounded-full transition-all duration-300 bg-pink-600 hover:bg-pink-700 text-white focus:outline-none focus:ring-2 focus:ring-pink-400">
            <i data-lucide="play" class="mr-2 play-icon"></i>
            <i data-lucide="stop-circle" class="mr-2 stop-icon hidden"></i>
            Tocar Lick
          </button>
        </div>
      `;
      // Vuelve a crear los íconos de Lucide
      lucide.createIcons();

      // Desactivar el botón de guardar si no hay lick
      document.getElementById('save-lick-btn').disabled = false;
      document.getElementById('export-lick-btn').disabled = false;
      
      // Añadir listener al botón de reproducir
      document.getElementById('play-lick-btn').addEventListener('click', () => {
        playLick(randomLick);
      });
    }

    function getDisplayModeName(modeString) {
      if (modeString.includes('Eolico')) return 'Eólica';
      if (modeString.includes('Frigio')) return 'Frigia';
      if (modeString.includes('Locrio')) return 'Locria';
      if (modeString.includes('jónico')) return 'Jónica';
      if (modeString.includes('Lidio')) return 'Lidia';
      if (modeString.includes('Mixolidio b6')) return 'Mixolidia b6';
      if (modeString.includes('Mixolidio b2 b6')) return 'Mixolidia b2 b6';
      if (modeString.includes('Mixolidio')) return 'Mixolidia';
      if (modeString.includes('Dorico')) return 'Dórica';
      return 'Modo';
    }

    function renderSavedLicks() {
      const container = document.getElementById('saved-licks-container');
      container.innerHTML = savedLicks.length > 0 ? '' : '<p class="text-center text-gray-400">No hay licks guardados.</p>';
      
      savedLicks.forEach((lick, lickIndex) => {
        const lickElement = document.createElement('div');
        lickElement.className = 'bg-gray-800 p-4 rounded-xl flex flex-col md:flex-row md:items-center justify-between shadow-md';
        
        let chordName = lick.mode.split('(')[0].trim();
        if (lick.mode.includes('sus4')) {
          chordName += '(sus4)';
        }
        
        const displayModeName = getDisplayModeName(lick.mode);
        const displayIntervals = lick.intervals.map(getDisplayIntervalName);

        lickElement.innerHTML = `
          <div class="flex-grow" id="saved-lick-content-${lickIndex}">
            <p class="text-lg font-bold text-teal-300 mb-2">
              ${lick.root} ${chordName} (${displayModeName}) Lick
            </p>
            <div id="saved-lick-notes-${lickIndex}" class="flex flex-wrap gap-2">
              ${lick.notes.map((note, noteIndex) => `
                <div id="saved-note-${lickIndex}-${noteIndex}" class="flex flex-col items-center p-1 rounded-md border-2 transition-all duration-300 border-transparent">
                  <span class="font-mono text-xl text-yellow-300">${note}</span>
                  <span class="text-xs text-gray-400">${displayIntervals[noteIndex]}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="flex flex-wrap space-x-2 mt-4 md:mt-0 justify-end">
            <button id="play-saved-lick-btn-${lickIndex}" class="p-3 rounded-full transition-all duration-300 bg-pink-600 hover:bg-pink-700 text-white focus:outline-none focus:ring-2 focus:ring-pink-400">
              <i data-lucide="play" class="play-icon"></i>
              <i data-lucide="stop-circle" class="stop-icon hidden"></i>
            </button>
            <button id="export-saved-lick-btn-${lickIndex}" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
              <i data-lucide="download"></i>
            </button>
            <button id="delete-saved-lick-btn-${lickIndex}" class="p-3 bg-red-600 hover:bg-red-700 text-white rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-red-400">
              <i data-lucide="trash-2"></i>
            </button>
          </div>
        `;
        container.appendChild(lickElement);

        // Vuelve a crear los íconos de Lucide
        lucide.createIcons();

        // Añadir listeners para los botones de reproducir, borrar y exportar
        document.getElementById(`play-saved-lick-btn-${lickIndex}`).addEventListener('click', () => {
          playLick(lick.notes, lickIndex);
        });
        document.getElementById(`delete-saved-lick-btn-${lickIndex}`).addEventListener('click', () => {
          deleteSavedLick(lickIndex);
        });
        document.getElementById(`export-saved-lick-btn-${lickIndex}`).addEventListener('click', () => {
          exportLickAsImage(`saved-lick-content-${lickIndex}`);
        });
      });
    }

    // Funciones principales de la aplicación
    function stopLick() {
      if (lickSequence) {
        lickSequence.dispose();
        lickSequence = null;
      }
      isLickPlaying = false;
      currentPlayingNoteIndex = null;
      currentLickPlayingIndex = null;
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      updatePlayButtons();
      updateHighlightedNotes();
    }

    function generateLick() {
      stopLick();
      const selectedRoot = document.getElementById('root-note').value;
      const selectedModeType = document.getElementById('mode-type').value;
      
      const modeFormula = MODE_FORMULAS[selectedModeType];
      const modeNotes = getCorrectlySpelledNotes(selectedRoot, modeFormula, selectedModeType);
      
      if (modeNotes.length === 0) return;
      
      const availableNotes = [...modeNotes];
      // Obtener el valor del slider para la longitud del lick
      const lickLength = parseInt(document.getElementById('lick-length-slider').value, 10);
      
      randomLick = [];
      randomLickIntervals = [];

      const finalLickLength = Math.min(lickLength, availableNotes.length);
      
      for (let i = 0; i < finalLickLength; i++) {
        const randomIndex = Math.floor(Math.random() * availableNotes.length);
        const noteName = availableNotes[randomIndex];
        randomLick.push(noteName);
        const intervalName = getIntervalName(selectedModeType, selectedRoot, noteName);
        randomLickIntervals.push(intervalName);
        availableNotes.splice(randomIndex, 1);
      }
      
      renderRandomLick();
    }
    
    async function playLick(lickToPlay, lickIndex = null) {
      if (isLickPlaying && currentLickPlayingIndex === lickIndex) {
        stopLick();
        return;
      } else if (isLickPlaying) {
        stopLick();
      }
      
      if (!synth || lickToPlay.length === 0) return;
      
      isLickPlaying = true;
      currentLickPlayingIndex = lickIndex;
      updatePlayButtons();
      await Tone.start();
      Tone.Transport.start();

      const sequenceNotes = lickToPlay.map((note, index) => ({ note: `${note}4`, index }));
      const noteDuration = '8n';

      lickSequence = new Tone.Sequence((time, { note, index }) => {
        currentPlayingNoteIndex = index;
        updateHighlightedNotes();
        synth.triggerAttackRelease(note, noteDuration, time);
      }, sequenceNotes, noteDuration);
      
      lickSequence.start(0);
      Tone.Transport.bpm.value = 120;
      
      const totalDuration = Tone.Time(noteDuration).toSeconds() * lickToPlay.length;
      
      Tone.Transport.scheduleOnce(() => {
        console.log('Lick finalizado. Deteniendo la reproducción.');
        stopLick();
      }, `+${totalDuration}`);
    }

    function saveCurrentLick() {
      if (randomLick.length === 0) return;
      const newLickToSave = {
        notes: randomLick,
        intervals: randomLickIntervals,
        root: document.getElementById('root-note').value,
        mode: document.getElementById('mode-type').value
      };
      savedLicks.push(newLickToSave);
      localStorage.setItem('savedModesLicks', JSON.stringify(savedLicks));
      renderSavedLicks();
    }

    function deleteSavedLick(indexToDelete) {
      if (isLickPlaying && currentLickPlayingIndex === indexToDelete) {
        stopLick();
      }
      savedLicks.splice(indexToDelete, 1);
      localStorage.setItem('savedModesLicks', JSON.stringify(savedLicks));
      renderSavedLicks();
    }

    // Función de exportar como imagen PNG
    function exportLickAsImage(lickId) {
      const lickElement = document.getElementById(lickId);
      if (!lickElement) {
          console.error(`Elemento con id "${lickId}" no encontrado.`);
          return;
      }
      
      // html2canvas no captura el fondo del body, por lo que creamos un div temporal
      const tempWrapper = document.createElement('div');
      tempWrapper.style.backgroundColor = '#1f2937'; // Color de fondo del body
      tempWrapper.style.padding = '20px';
      tempWrapper.style.borderRadius = '1rem';
      tempWrapper.style.display = 'inline-block';
      
      const clone = lickElement.cloneNode(true);
      clone.style.width = lickElement.offsetWidth + 'px';
      clone.style.height = lickElement.offsetHeight + 'px';
      
      // Aplicar estilos del contenedor
      const containerStyles = window.getComputedStyle(lickElement.parentElement);
      clone.style.backgroundColor = containerStyles.backgroundColor;
      clone.style.padding = containerStyles.padding;
      clone.style.borderRadius = containerStyles.borderRadius;
      
      tempWrapper.appendChild(clone);
      document.body.appendChild(tempWrapper);
      
      html2canvas(tempWrapper, {
          backgroundColor: '#111827', // Fondo del elemento padre, para que el resultado sea consistente
          scale: 2 // Escala para una mejor resolución
      }).then(canvas => {
          const image = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.download = `lick-modal.png`;
          link.href = image;
          link.click();
          tempWrapper.remove();
      }).catch(err => {
          console.error('Error al exportar la imagen:', err);
          tempWrapper.remove();
      });
    }
    
    // Funciones de actualización de UI
    function updatePlayButtons() {
      // Botón del lick aleatorio
      const playRandomBtn = document.getElementById('play-lick-btn');
      if (playRandomBtn) {
        const playIcon = playRandomBtn.querySelector('.play-icon');
        const stopIcon = playRandomBtn.querySelector('.stop-icon');
        if (isLickPlaying && currentLickPlayingIndex === null) {
          playRandomBtn.classList.remove('bg-pink-600', 'hover:bg-pink-700');
          playRandomBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          playRandomBtn.childNodes[3].nodeValue = 'Detener Lick';
          playIcon.classList.add('hidden');
          stopIcon.classList.remove('hidden');
        } else {
          playRandomBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
          playRandomBtn.classList.add('bg-pink-600', 'hover:bg-pink-700');
          playRandomBtn.childNodes[3].nodeValue = 'Tocar Lick';
          playIcon.classList.remove('hidden');
          stopIcon.classList.add('hidden');
        }
      }

      // Botones de licks guardados
      savedLicks.forEach((_, index) => {
        const playBtn = document.getElementById(`play-saved-lick-btn-${index}`);
        if (playBtn) {
          const playIcon = playBtn.querySelector('.play-icon');
          const stopIcon = playBtn.querySelector('.stop-icon');
          if (isLickPlaying && currentLickPlayingIndex === index) {
            playBtn.classList.remove('bg-pink-600', 'hover:bg-pink-700');
            playBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            playIcon.classList.add('hidden');
            stopIcon.classList.remove('hidden');
          } else {
            playBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            playBtn.classList.add('bg-pink-600', 'hover:bg-pink-700');
            playIcon.classList.remove('hidden');
            stopIcon.classList.add('hidden');
          }
        }
      });
    }

    function updateHighlightedNotes() {
      // Limpiar todas las notas
      document.querySelectorAll('[id^="random-note-"]').forEach(el => {
        el.classList.remove('border-yellow-300', 'shadow-md', 'shadow-yellow-500', 'animate-pulse');
        el.classList.add('border-transparent');
      });
      document.querySelectorAll('[id^="saved-note-"]').forEach(el => {
        el.classList.remove('border-yellow-300', 'shadow-md', 'shadow-yellow-500', 'animate-pulse');
        el.classList.add('border-transparent');
      });

      // Iluminar la nota actual
      if (isLickPlaying && currentPlayingNoteIndex !== null) {
        let noteElement = null;
        if (currentLickPlayingIndex === null) {
          noteElement = document.getElementById(`random-note-${currentPlayingNoteIndex}`);
        } else {
          noteElement = document.getElementById(`saved-note-${currentLickPlayingIndex}-${currentPlayingNoteIndex}`);
        }
        if (noteElement) {
          noteElement.classList.add('border-yellow-300', 'shadow-md', 'shadow-yellow-500', 'animate-pulse');
          noteElement.classList.remove('border-transparent');
        }
      }
    }

    // Inicialización de la aplicación al cargar la página
    window.onload = function() {
      try {
        // Inicializar los iconos de Lucide
        lucide.createIcons();

        // Inicializar el sintetizador
        synth = new Tone.Synth({
          oscillator: { type: 'triangle' },
          envelope: { attack: 0.05, decay: 0.5, sustain: 0.5, release: 0.5 }
        }).toDestination();
        
        // Cargar licks guardados de localStorage
        const storedLicks = localStorage.getItem('savedModesLicks');
        if (storedLicks) {
          savedLicks = JSON.parse(storedLicks);
        }

        // Llenar los selectores de notas y modos
        const rootSelect = document.getElementById('root-note');
        if (rootSelect) {
            NOTES.forEach(note => {
                const option = document.createElement('option');
                option.value = note;
                option.textContent = note;
                rootSelect.appendChild(option);
            });
        }

        const modeSelect = document.getElementById('mode-type');
        if (modeSelect) {
            Object.keys(MODE_FORMULAS).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                modeSelect.appendChild(option);
            });
        }

        // Añadir listeners para los cambios en los selectores
        if (rootSelect && modeSelect) {
            rootSelect.addEventListener('change', () => {
                updateScaleAndChordDisplay(rootSelect.value, modeSelect.value);
                generateLick();
            });
            modeSelect.addEventListener('change', () => {
                updateScaleAndChordDisplay(rootSelect.value, modeSelect.value);
                generateLick();
            });
        }

        // Añadir listeners para el nuevo slider de longitud de lick
        const lickLengthSlider = document.getElementById('lick-length-slider');
        const lickLengthValue = document.getElementById('lick-length-value');
        
        if (lickLengthSlider && lickLengthValue) {
            // Sincronizar el valor inicial
            lickLengthValue.textContent = lickLengthSlider.value;
            lickLengthSlider.addEventListener('input', () => {
                lickLengthValue.textContent = lickLengthSlider.value;
                generateLick();
            });
        }

        // Añadir listeners para los botones de la sección de lick aleatorio
        document.getElementById('generate-lick-btn')?.addEventListener('click', generateLick);
        document.getElementById('save-lick-btn')?.addEventListener('click', saveCurrentLick);
        document.getElementById('export-lick-btn')?.addEventListener('click', () => {
            if (randomLick.length > 0) {
                exportLickAsImage('random-lick-notes-container');
            }
        });
        
        // Renderizar la UI inicial
        updateScaleAndChordDisplay(rootSelect.value, modeSelect.value);
        generateLick();
        renderSavedLicks();

      } catch (e) {
        console.error("Error during application initialization:", e);
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        if (errorMessageDiv && errorDetails) {
            errorDetails.textContent = `Detalles del error: ${e.message}. Por favor, recarga la página.`;
            errorMessageDiv.classList.remove('hidden');
            lucide.createIcons();
        }
      }
    };
  </script>
</body>
</html>
